{% extends 'base.html' %}

{% block styles %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/product_style.css' %}">
{% endblock %}

{% block title %} Детали продукта {% endblock %}
{% block content %}
    <section class="catalog_product">
    <div class="first_block_product">
        <a href="{{ request.META.HTTP_REFERER|default:'/' }}" class="back">
            <img class="back_img" src="{% static 'images/Vector(1).png' %}">
            <div>Назад</div>
        </a>
        <div class="foto_product" style="background-image:url('{{ product.photos.all.0.photo.url }}')">
        <!-- Лайк -->
        {% if user.is_authenticated %}
            {% if liked %}
            <img class="like-img" src="{% static 'images/Vector1.png' %}" data-product-id="{{ product.pk }}" style="cursor:pointer;">
            {% else %}
            <img class="like-img" src="{% static 'images/Vector.png' %}" data-product-id="{{ product.pk }}" style="cursor:pointer;">
            {% endif %}
        {% else %}
        <img class="like-img register-btn" src="{% static 'images/Vector.png' %}" data-product-id="{{ product.pk }}" style="cursor:pointer;">
        {% endif %}
        </div>
        {% if product.photos.count > 1 %}
        <div class="fotos_product_dop" style="display: flex;">
        {% for photo in product.photos.all|slice:"1:4" %}
            <img class="foto_product_dop" src="{{photo.photo.url}}" alt="Изображение продукта" />
        {% endfor %}
        </div>
        {% endif %}
    </div>
    <div class="fsecond_block_product">
        <div class="name_stock">
            <h1 class="name_product"> {{product.name}} </h1>
            {% if product.stock %}
            <div class="stock_product"> {{product.stock}} </div>
            {% else %}
            <div></div>
            {% endif %}
        </div>

        {% load price_extras %}

        <div class="price">
            {% if product.stock %}
            {% with discount_percentage=product.stock.discount|add:"0" %}
            {% with original_price=product.price %}
            {% with discount_amount=original_price|mul:discount_percentage|div:100 %}
            {% with discounted_price=original_price|subtract:discount_amount %}
            <div class="price_product"> {{ discounted_price|floatformat:0 }} ₽</div>
            {% endwith %}
            {% endwith %}
            {% endwith %}
            <div class="price_product_stock"><span class="strikethrough">{{ product.price|floatformat:0 }}</span> ₽</div>
            {% endwith %}
            {% else %}
            <div class="price_product"> {{ product.price|floatformat:0 }} ₽</div>
            {% endif %}
        </div>

        <div class="info_product">
            <div class="description">Описание</div>
            <div class="description_text">{{product.description}}</div>
        </div>

        <div class="basket">
            <button class="basket_count" type="button">Добавить в корзину</button>
            <button class="basket_put" type="button">В корзину</button>
        </div>
    </div>
    </section>
    <script>
        const images = document.querySelectorAll('.foto_product_dop');

        images.forEach((img) => {
          img.addEventListener('click', () => {
            // Увеличиваем картинку
            img.classList.toggle('enlarged');

            // Если увеличилась — добавляем обработчик на весь документ
            if (img.classList.contains('enlarged')) {
              document.addEventListener('click', outsideClickListener);
            } else {
              document.removeEventListener('click', outsideClickListener);
            }

            // Функция для проверки клика вне картинки
            function outsideClickListener(e) {
              if (!img.contains(e.target)) {
                img.classList.remove('enlarged');
                document.removeEventListener('click', outsideClickListener);
              }
            }
          });
        });
    </script>

{% endblock %}